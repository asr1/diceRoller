<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-beta/css/materialize.min.css">
    <title>Dice Roller</title>

    <style>
        
        .chart rect {
        fill: steelblue;
        }

        .chart text {
        fill: white;
        font: 10px sans-serif;
        text-anchor: end;
        }
    </style>

</head>
<body>
    <nav>
        <div class="nav-wrapper">
            <a class="brand-logo center">Dice Roller</a>
        </div>
    </nav>
    <div class="container">
        <p></p>
        <svg class="chart"></svg>
        <div>
            <div><h4>Stats</h4></div>
            <div>Average:<span id="avg"></span></div>
            <div>Sum: <span id="sum"></span></div>
            <div>Standard Deviation:<span id="std"></span></div>
        </div>
        <ul></ul>
    </div>

<script>
    const electron = require('electron');
    const {ipcRenderer} = electron;
    var d3 = require("d3");
    const sum = document.getElementById('sum');
    const avg = document.getElementById('avg');
    const std = document.getElementById('std');
    const ul = document.querySelector('ul');

    //Catch roll dice
    ipcRenderer.on('roll', (e, param) => {
        var values = roll(param);
        console.log("going");
        drawGraph(values);
    });

    //Clear history
    ipcRenderer.on('clearHistory', () => {
        ul.innerHTML = '';
        sum.innerHTML = '';
        std.innerHTML = '';
        avg.innerHTML = '';
    });

    function drawGraph(data)
    {
        var width = 400,
        height = 400;

        var y = d3.scaleLinear()
            .range([height, 0]);

        var chart = d3.select(".chart")
            .attr("width", width)
            .attr("height", height);

        y.domain([0, d3.max(data, function(d) { return d })])

         var barWidth = width / data.length;

        var bar = chart.selectAll("g")
      .data(data)
    .enter().append("g")
      .attr("transform", function(d, i) { return "translate(" + i * barWidth + ",0)"; });

  bar.append("rect")
      .attr("y", function(d) { return y(d); })
      .attr("height", function(d) { return height - y(d); })
      .attr("width", barWidth - 1);

  bar.append("text")
      .attr("x", barWidth / 2)
      .attr("y", function(d) { return y(d) + 3; })
      .attr("dy", ".75em")
      .text(function(d) { return d; });
};

function type(d) {
  d.value = +d.value; // coerce to number
  return d;
}

    function roll(param)
    {
        rolls = [];
        rollscount = [];
       // console.log(param)
       // console.log(param.numTrials);
       // console.log(param.diceSize);
        let rollSum = 0;
        for(var i = 0; i < param.numTrials; i++)
        {
            var roll = rollDice(param.numDice, param.diceSize, param.addEach, param.reRolls);
            roll += param.addTotal;

            const li = document.createElement('li');
            li.className = 'collection-item';
            const itemText = document.createTextNode(roll);
            ul.className = 'collection';
            li.appendChild(itemText);
            ul.appendChild(li);

            rolls.push(roll);
            rollscount[roll] !== undefined ? rollscount[roll]++ : rollscount[roll] = 0;
            rollSum += roll;
        }
        sum.innerHTML = rollSum;
        avg.innerHTML = rollSum/param.numTrials;
        std.innerHTML = Math.round(rolls.stanDeviate() * 100) / 100;
        console.log(rollscount)
        return rollscount;
        
      //numTrials, numDice, diceSize, addEach, addTotal, reRolls
    }

        Array.prototype.stanDeviate = function(){
        var i,j,total = 0, mean = 0, diffSqredArr = [];
        for(i=0;i<this.length;i+=1){
            total+=this[i];
        }
        mean = total/this.length;
        for(j=0;j<this.length;j+=1){
            diffSqredArr.push(Math.pow((this[j]-mean),2));
        }
        return (Math.sqrt(diffSqredArr.reduce(function(firstEl, nextEl){
                    return firstEl + nextEl;
                })/this.length));
        };

    function rollDice(numDice, sizeOfDice, addToEach = 0, reRolls){
        var sum = 0;
        for(var i = 0; i < numDice; i++)
        {
          //  console.log("Rolling dice");
         //   console.log(numDice + "d" + sizeOfDice)
          //  console.log("+ " + addToEach)
            do{
                var roll = rollDie(sizeOfDice)
            } while(reRolls.includes(roll));
            roll+= addToEach;
         //   console.log(roll);
            sum += roll
        }
        return sum;
    }

    function rollDie(size){
        return Math.floor(Math.random() * size) + 1;
    }


</script>

</body>
</html>